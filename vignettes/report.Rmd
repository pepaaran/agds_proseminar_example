---
title: "Downscaling VPD and temperature data"
author: "Pepa Arán"
output: rmarkdown::html_vignette
---

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())

library(dplyr)
library(stringr)
library(terra)
library(ggplot2)
library(tidyterra)
library(maps)
library(rnaturalearth)
library(rnaturalearthdata)
library(leaflet)
```

# Introduction

This report presents an Applied Geo-Data Science project aimed at spatially downscaling daily Vapor Pressure Deficit (VPD) and temperature values to address vegetation modelling questions. By improving the spatial resolution of climatic data, we can gain valuable insights into the relationships between environmental variables and vegetation dynamics at finer scales. 

This project proposes the integration of daily meteorological data from the WATCH-WFDEI dataset with a finer spatial grid dataset like Worldclim, which provides averaged values over 30 years, to achieve higher spatial resolution. Average daily temperature data is directly provided in both datasets and we will use measurements of specific humidity from WATCH-WFDEI and vapour pressure from Worldclim to compute VPD. A simple de-biasing technique will be employed to combine the two datasets effectively. Finally, the quality of the downscaling will be evaluated through various means, including visualization and comparison with temperature and VPD measurements from FLUXNET2015 sites.
 
# Data selection

The following datasets were chosen, among a variety of public datasets, because, combined, they allow us to obtain daily values of temperature and vapor pressure deficit at a very fine spatial resolution (30sec or cells of approximately 700m (lon) by 900m (lat) in Switzerland).

## Daily global climate data from WATCH-WFDEI

WATCH-WFDEI provides monthly climate fields at 0.5 degree resolution from 1979 to 2012. The following variables are relevant for our project, although many more are provided in the WATCH-WFDEI dataset.

- **Tair** is the daily average (of 3-hourly) near surface air temperature (in Kelvin) at 2m at time stamp
- **Qair** is the daily average specific humidity (in kg/kg) at 2m above surface
- **PSurf** is the daily average surface pressure (in hPa) 

The data can be downloaded from the IIASA website via ftp for each variable separately. We used the `src/download_watch_wfdei.sh` script to get the data automatically.

After downloading the data, we can read the netCDF files with the `terra` package and extract the information we're interested in. For example, `Tair_daily_WFDEI_197901.nc` contains average temperature values for each day of January 1979 and each pixel in a 0.5 degree grid (approximately 55x55km cells at the equator and 55x42km at the latitude of Switzerland) covering the whole globe. Therefore, to get the time series of temperature for any given pixel, we would need to open all files and extract values for just that pixel, then concatenate them all.

Let's start by reading the temperature data for the month of January 1979 only and see how it looks. The raster contains a layer per day, but we plot the monthly average.
```{r fig.width=7, fig.height=5}
# Path for WATCH-WFDEI data (directory containing the .nc files)
path_watch <- "data-raw/wfdei_weedon_2014/Tair_daily"

# Get the list of .nc files in the directory
file_list <- list.files(path_watch, pattern = "*.nc", full.names = TRUE)

# Read the temperature data for January, K -> deg C
temp_watch <- terra::rast(file_list[1]) - 273.15

# Plot month average
ggplot() +
  tidyterra::geom_spatraster(data = temp_watch |>
                               terra::app(mean, na.rm = TRUE)) +
  scale_fill_viridis_c(
    na.value = NA,
    name = "Temperature (deg C) \n"
    ) +
  theme_bw() +
  theme(
    legend.position = "bottom"
    )
```


## Monthly climatology global maps from WorldClim

The WorldClim dataset contains historical climate data for the period 1970-2000, available at various spatial resolutions. The finest, 30sec gridded data from WorldClim can be directly downloaded from https://www.worldclim.org/data/worldclim21.html as .zip files. We are interested in the following variables:

- **tavg**: average monthly temperature ($^\text{o}$C)
- **vapr**: water vapor pressure (kPa)

For each variable, 12 .tif files are downloaded. Each file from WorldClim contains the monthly average of a single climatic variable across the whole globe, in pixels of 30s (900x900m at the equator and 900x700m in Switzerland). To get an idea of the magnitude of our downscaling task, note that each WATCH-WFDEI pixel contains approximately 120 WorldClim pixels.

Just like we did before, let's take a look at the average temperature across the globe in January, between the years 1970-2000.
```{r fig.width=7, fig.height=5}
# Path for WorldClim data
path_worldclim <- "data-raw/worldclim_fick_2017"

# Read the temperature data for January
temp_worldclim <- terra::rast(paste0(path_worldclim, "/wc2.1_30s_tavg_01.tif"))

# Plot average
ggplot() +
  tidyterra::geom_spatraster(data = temp_worldclim) +
  scale_fill_viridis_c(
    na.value = NA,
    name = "Temperature (deg C) \n"
    ) +
  theme_bw() +
  theme(
    legend.position = "bottom"
    )
```

One can already tell that these data are more granular than the temperature map from WATCH-WFDEI. This is particularly visible in mountainous regions and we even get a message indicating that the data had to be regridded to a lower resolution to be plotted.

Due to the fine spatial resolution of the WorldClim dataset, performing calculations on the monthly raster files is very memory intensive. Running the code locally is not feasible, therefore we have focused on the area of Switzerland for the remainder of the project. Whenever bigger computational resources are available, the same code can be used to obtain global maps with downscaled values of temperature and VPD.

## Daily measurements from FLUXNET2015

The FLUXNET2015 dataset includes continuous measurements of ecosystem fluxes (CO2, water vapor, latent heat...) and physical variables (air temperature, precipitation, radiation...), from 212 sites around the world and in high temporal resolution (half-hourly, daily, monthly...). We will use these data as a validation for the downscaling, since we want the downscaled data to approximate local measurements as closely as possible.

To download the data, it's necessary to create an AMERIFLUX account. After logging in, the data can be directly downloaded in .zip files from https://fluxnet.org/data/download-data/, filtering for the 6 Swiss sites with the prefix CH. All variables are described in the table [here](https://fluxnet.org/data/fluxnet2015-dataset/fullset-data-product/) and in the [AGDS I book](https://geco-bern.github.io/agds/datawrangling.html#example-data).

We are interested in the following variables from the daily files (DD):

- TIMESTAMP: Time stamp in short format (YYYYMMDDHHMM).
- TA_F: Air temperature (in $^\text{o}$C), averaged from half-hourly data into daily data and gap-filled.
- TA_F_QC: Quality flag for TA_F, indicating the fraction between 0-1 of measured temperature vs gap-filled data. 1 corresponds to measured data only.
- VPD_F: Vapor Pressure Deficit (in hPa), averaged from harlf-hourly data into daily data and gap-filled.
- VPD_F_QC: Quality flag for VPD_F, indicating the fraction between 0-1 of measured VPD vs gap-filled data. 1 corresponds to measured data only.

The time stamp will allow us to compare the measurements in this time-series to daily values from the downscaled raster files. Furthermore, we can filter the temperature and VPD time-series to retain only measured data, thus avoiding the comparison of our downscaled WATCH-WFDEI data with downscaled ERA5 data (which the FLUXNET product uses for gap filling).

Let's take a look at the time series of temperature in the Davos site, together with the quality of the data (observed vs. gap-filled). Most of the data from 1997 to 2014 were measured, except for a period in 2005 and some sporadic days. For all the Swiss FLUXNET sites, more than 50\% of the time-series comes from observations only.

<!-- Plot of a time series of temperature and VPD and the distribution of data quality (color). -->
```{r fig.height = 3, fig.width=7}
# Define data path
path_fluxnet <- "data-raw/fluxnet_pastorello_2020"

# Read .csv file and select relevant variables
dd <- read.csv(paste0(path_fluxnet, 
                      "/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-4.csv")) |>
  dplyr::select(TIMESTAMP,
                TA_F,
                TA_F_QC,
                VPD_F,
                VPD_F_QC) |>
  dplyr::mutate(TIMESTAMP = as.Date(strptime(TIMESTAMP, format = "%Y%m%d")))

# Prepare data for plotting
dd_plot <- data.frame(TIMESTAMP = dd$TIMESTAMP,
                      variable = c(rep("Temperature (C)", nrow(dd)),
                                   rep("VPD (hPa)", nrow(dd))),
                      value = c(dd$TA_F,
                                dd$VPD_F),
                      qc = c(dd$TA_F_QC,
                             dd$VPD_F_QC))

# Plot temperature and VPD in Davos
ggplot(data = dd_plot) +
  geom_line(aes(x = TIMESTAMP , y = value, col = qc)) +
  scale_color_viridis_c() +
  facet_wrap(~ variable, scales = 'free') +
  theme_classic() +
  theme(panel.grid.major.y = element_line())

```

# Data processing

The `terra` package simplifies the processing of all raster files. We implemented custom processing functions that read .tif (from WorldClim) and .nc (from WATCH-WFDEI) files, aggregate data over the time axis, re-grid raster files and perform complex operations to all data pixels. All these functions are stored in the `R/` folder.


## Calculating vapor pressure deficit (VPD)

Vapor Pressure Deficit is defined as the difference between the saturation vapor pressure ($e_s$) and the actual vapor pressure ($e$). It indicates the evaporative potential of air, therefore informing the rate of photosynthesis in vegetation models.

$$ VPD = e_S - e $$
The saturation vapor pressure, i.e. the maximum amount of water vapor that air can hold, increases exponentially with warmer temperature. Warm air ca hold considerably more water when saturated than can colder air. It can be computed following eq. 5.1 in Evaporation and Evapotranspiration (Abtew and Meleese 2013, Ch 5),

$$ e_S (T) = 611 \; \exp \left({\frac{17.27 \; T}{T + 237.3}} \right) $$

where temperature ($T$) is given in degrees Celsius and the resulting $e_S$ is in Pa.

### Computing VPD with WorldClim data

The [WorldClim dataset](https://www.worldclim.org/data/worldclim21.html) provides, among others, the following variables:

- **tavg**: average monthly temperature (Celsius)
- **vapr**: water vapor pressure (kPa)

Therefore, VPD can easily computed from the equation above, doing an easy unit change. Let's create a function that does this calculation:
```{r eval = FALSE}
calc_vpd_from_vapr <- function(t, e){
  # t: temperature in degrees C
  # e: water vapor pressure in Pa
  
  # Calculate e_S (saturation vapor pressure) as a function of temperature
  e_S <- 611.0 * exp( (17.27 * t)/(t + 237.3) )
  
  # Calculate VPD
  e_S - e
}
```

### Computing VPD with WATCH-WFDEI data

The [WATCH-WFDEI dataset](https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2014WR015638) provides many variables, including:

- **Tair**: daily average (of 3-hourly) near surface air temperature (in Kelvin) at 2m at time stamp.
- **Qair**: daily average specific humidity (in kg water / kg air) at 2m above surface.
- **PSurf**: daily average surface total pressure (in hPa).

Since water vapor pressure measurements are not available directly, we need to compute it from the variables that we have.

Specific humidity ($q$) is defined as the ratio of the mass of water vapor in a parcel of air to the total mass of the air. Following Eq. 3.15 in Ecological Climatology (Bonan, 2008), specific humidity can be computed as:

$$ q = \frac{0.622 e}{P - 0.378 e} $$

where $P$ is the total air pressure in Pa and $e$ the water vapor pressure. This equation and its constants are derived from the ideal gas law and the gas constants for water vapor and dry air. Because water vapor typically comprises 1 - 4\% of air, the partial pressure of air due to water vapor is much smaller than the total air pressure, that is $ P >> e$. Thus we obtain an approximation for the actual water vapor pressure:

$$ e = 1.608 \; q \; P $$

Analogously, we can define a function that calculates VPD from the variables available in WATCH-WFDEI:
```{r eval = FALSE}
calc_vpd_from_qair <- function(t, q, P){
  # t: temperature in degrees C
  # q: specific humidity in kg/kg
  # P: total air pressure in Pa
  
  # Calculate e_S (saturation vapor pressure) as a function of temperature
  e_S <- 611.0 * exp( (17.27 * t)/(t + 237.3) )
  
  # Approximate e (actual vapor pressure) from total air pressure and specific
  # humidity
  e <- 1.608 * q * P
  
  # Calculate VPD
  e_S - e
}
```

## Downscaling workflow

Here we present the full workflow for the project, from raw raster data to the downscaled daily values. The main parts of the downscaling workflow are the following:

- Read WATCH-WFDEI data, perform unit transformations and calculate VPD from the raw, 0.5deg WATCH-WFDEI data (save daily values in files for future use).
- Calculate average monthly climatology from the WATCH-WFDEI daily data.
- Read WorldClim data, transform units and calculate VPD.
- Resample WATCH-WFDEI-derived climatology to WorldClim resolution and compute the climatology bias (save bias in files for future use). That is, for temperature (analogously for VPD),
$$T_{\text{bias}} = T_{\text{WATCH}} - T_{\text{WorldClim}}$$
- Resample daily data and substract the bias. 
$$T_t = T_{WATCH, \; t} - T_{bias}$$

We implemented the whole downscaling workflow, from raw data to the final downscaled temperature and VPD, saved in .tif files, into a function called `downscale_t_vpd()`. Because of the raw data structure, it's most efficient to separate all computations by month. That way, the WorldClim data doesn't need to be loaded repeatedly and the monthly climatology from WATCH-WFDEI is computed and directly used in the code, reducing runtime. Our function also performs all the unit changes and VPD calculations and saves daily values of temperature and VPD at 0.5deg resolution in the `data/` folder, for years 1979-2018, to be processed later. Finally, for the time interval indicated as argument, the data are de-biased and the downscaled values saved. Below we run the whole procedure.

```{r}
# Data paths were defined above

# Load all custom functions
source("R/calc_vpd_from_qair.R")
source("R/calc_vpd_from_vapr.R")
source("R/compute_monthly_climatology.R")
source("R/get_daily_t_vpd.R")
source("R/get_worldclim_t_vpd.R")
source("R/debias_t_vpd.R")
source("R/downscale_t_vpd.R")

# Create Switzerland map object, used to crop raster data
swiss_map <- ne_countries(scale = "medium", 
                          country = "Switzerland", 
                          returnclass = "sf")
```

<!-- Do not compute whenever knitting, but rather load the saved files in the remaining code chunks. -->
```{r eval = FALSE}
# Loop over months to process data
for(m in 1:12){
  download_t_vpd(
    path_worldclim = path_worldclim,
    path_watch = path_watch,
    crop_map = swiss_map,
    month = m,                            
    downscale_years = 1997:2014,          # Years with FLUXNET observations
    compute_bias = TRUE,
    cores = 1                             # single core in personal computer
    )
}

```

Now we can visually inspect the downscaling procedure. Let's take a look at the downscaled data, compared to the original WATCH-WFDEI map of October 1st, 1997.
```{r fig.width=7, fig.height=5}
source("R/plot_daily.R")

# Plot original daily average temperature
p1 <- plot_daily("data/tavg_vpd_daily_199710.tif",
           layer_name = "tavg", day = 0)

# Plot downscaled temperature
p2 <- plot_daily("data/tavg_vpd_daily_downscaled_199710.tif",
           layer_name = "tavg", day = 0)

# Plot original daily average VPD
p3 <- plot_daily("data/tavg_vpd_daily_199710.tif",
           layer_name = "vpd", day = 0)

# Plot downscaled VPD
p4 <- plot_daily("data/tavg_vpd_daily_downscaled_199710.tif",
           layer_name = "vpd", day = 0)

cowplot::plot_grid(p1, p2, p3, p4)
```

The downscaled maps of both temperature and VPD values are in similar ranges to the 0.5deg original data. The local variations reflect the topography of Switzerland, as we would have expected. Next, we will compare the downscaled tempearture and VPD to measurements taken at surface level.

# Data evaluation

- Selection of FLUXNET sites and explanation of site differences

We are interested in daily averages of temperature and VPD from various Swiss FLUXNET sites (see information [here](https://fluxnet.org/sites/site-list-and-pages/). In the following plot, we show the locations of the flux sites in Switzerland. You can hover over the dots to read their names.

<!-- Plot of the Swiss map with the site locations. -->
```{r fig.width=7, fig.height=5}
# Define FLUXNET site information from online table
fluxnet_sites <- data.frame(
  site_code = c("CH-Cha", "CH-Dav", "CH-Fru", "CH-Lae", "CH-Oe1", "CH-Oe2"),
  site_name = c("Chamau", "Davos", "Früebüel", "Laegern", 
                "Oesingen grassland", "Oesingen crop"),
  lon = c(8.4104, 9.8559, 8.5378, 8.3644, 7.7319, 7.7337),
  lat = c(47.2102, 46.8153, 47.1158, 47.4783, 47.2858, 47.2864),
  elv = c(393, 1639, 982, 689, 450, 452)
)

# Plot locations with leaflet
leaflet() |>
  addProviderTiles(providers$Esri.WorldImagery, group = "World Imagery") |>
  addCircleMarkers(lng = fluxnet_sites$lon,
             lat = fluxnet_sites$lat,
             label = paste0(fluxnet_sites$site_code, " (", fluxnet_sites$site_name, ")")) |>
  fitBounds(lng1 = 5.966667, lng2 = 10.45833,
            lat1 = 45.83333, lat2 = 47.775)

```

- Visual comparison

- Discussion

> NOTE: In your full report, there should be additional sections containing the modelling and analysis components of the project. 

# Conclusion

# References




# VPD downscaling 

Processing raster data in high resolution is memory and computationally intensive
```{r eval = FALSE}
# Load defined functions
source("R/calc_vpd_from_qair.R")
source("R/calc_vpd_from_vapr.R")
source("R/compute_monthly_climatology.R")
source("R/get_daily_t_vpd.R")
source("R/get_worldclim_t_vpd.R")
source("R/debias_t_vpd.R")
source("R/downscale_t_vpd.R")

# The last function calls the others internally, such that a single function
# call processes all data for a given month.
downscale_t_vpd(
  path_worldclim = "~/data/archive/worldclim_fick_2017/data",
  path_watch = "~/data/archive/wfdei_weedon_2014/data",
  crop_map = rnaturalearth::ne_countries(scale = "medium", 
                                         country = "Switzerland", 
                                         returnclass = "sf"),
  month = 2,     # February
  downscale_years = 1997:2014,
  cores = 1
)
```


