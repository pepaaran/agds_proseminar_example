---
title: "Downscaling VPD and temperature data"
author: "Pepa Ar√°n"
output: rmarkdown::html_vignette
---

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())

library(dplyr)
library(stringr)
library(terra)
library(ggplot2)
library(tidyterra)
```

# Introduction

This report presents an Applied Geo-Data Science project aimed at spatially downscaling daily Vapor Pressure Deficit (VPD) and temperature values to address vegetation modelling questions. By improving the spatial resolution of climatic data, we can gain valuable insights into the relationships between environmental variables and vegetation dynamics at finer scales. 

This project proposes the integration of daily meteorological data from the WATCH-WFDEI dataset with a finer spatial grid dataset like Worldclim, which provides averaged values over 30 years, to achieve higher spatial resolution. Average daily temperature data is directly provided in both datasets and we will use measurements of specific humidity from WATCH-WFDEI and vapour pressure from Worldclim to compute VPD. A simple de-biasing technique will be employed to combine the two datasets effectively. Finally, the quality of the downscaling will be evaluated through various means, including visualization and comparison with temperature and VPD measurements from FLUXNET2015 sites.
 
# Data selection

- WATCH-WFDEI + show  global plot

- WorldClim + show global plot

- FLUXNET2015 + show time series from Laegern

# Data processing

- The `terra` package simplifies the processing of all raster files. We implemented custom processing functions that read .tif (from WorldClim) and .nc (from WATCH-WFDEI) files, aggregate data over the time axis, re-grid raster files and perform complex operations to all data pixels. 

- Calculating VPD

- Due to the fine spatial resolution of the WorldClim dataset, performing calculations on the monthly raster files is very memory intensive. Running the code locally is not possible, therefore we have focused on the area of Switzerland for the remainder of the project. Whenever bigger computational resources are available, the same code could be used to obtain global maps with downscaled values of temperature and VPD.

- Downscaling workflow

- Results and plots, comparing downscaled values

# Data evaluation

- Selection of FLUXNET sites and explanation

- Visual comparison

- Discussion

# Conclusion

# Reading the raw data

Instead of getting the global map, we will first implement the procedure for the gird cells corresponding to the swiss FLUXNET2015 sites.

```{r}
# Load location information about the Flux sites
load("data/siteinfo_fluxnet2015.rda")

# Select the swiss sites only
swiss_sites <- siteinfo_fluxnet2015 |>
  filter(str_starts(sitename, "CH")) |>
  select(sitename, lon, lat, elv, year_start, year_end, plant_functional_type)

swiss_sites
```


## Read daily data from WATCH-WFDEI

WATCH-WFDEI provides monthly climate fields at 0.5 degree resolution from 1979 to 2012. 
The data can be downloaded from the IIASA website via ftp for each variable separately:
- **Tair** is the daily average (of 3-hourly) near surface air temperature (in Kelvin) at 2m at time stamp.
- **Qair** is


After downloading the data from the IIASA website via ftp, we can read the netCDF files and extract the information we're interested in. For example, `Tair_daily_WFDEI_197901.nc` contains average temperature values for each day of January 1979 and each pixel in a 0.5 degree grid covering the whole globe. Therefore, to get the time series of temperature for a given pixel

```{r eval = FALSE}

# Set the path to the directory containing the .nc files
path_watch <- "~/data/archive/wfdei_weedon_2014/data/Tair_daily"

# Get the list of .nc files in the directory
file_list <- list.files(path_watch, pattern = "*.nc", full.names = TRUE)

# Define function to get average monthly temperature
get_monthly_average <- function(file, var){
  # file: full path of the .nc file
  # var: variable saved in the raster, either "temperature" or "vpd"
  
 
  
  if(var == "temperature"){
    # Read file and convert Kelvin -> Celsius
    rasta <- terra::rast(file) - 273.15 
  }else if(var == "vpd"){
    # Read file
    rasta <- terra::rast(file)
    # Calculate VPD from Qair (specific humidity)
    
  }
  # Compute mean monthly values and return raster layer
  terra::app(rasta, mean, na.rm = TRUE)
}

lapply(file_list, get_monthly)

# Get average monthly temperature
temp_avg <- terra::app(temp, mean, na.rm = TRUE)

# Plot average monthly temperature in January 1979
ggplot() +
  tidyterra::geom_spatraster(data = temp_avg) +
  scale_fill_viridis_c(
    na.value = NA,
    name = "Temperature (C) \n"
    ) +
  theme_bw() +
  theme(
    legend.position = "bottom"
    )
```


## Read monthly average climatology from WorldClim

The WorldClim dataset represents average monthly climate data for 1970-2000.


# VPD downscaling 

Processing raster data in high resolution is memory and computationally intensive
```{r}
# Load defined functions
source("R/calc_vpd_from_qair.R")
source("R/calc_vpd_from_vapr.R")
source("R/compute_monthly_climatology.R")
source("R/get_daily_t_vpd.R")
source("R/get_worldclim_t_vpd.R")
source("R/debias_t_vpd.R")
source("R/downscale_t_vpd.R")

# The last function calls the others internally, such that a single function
# call processes all data for a given month.
downscale_t_vpd(
  path_worldclim = "~/data/archive/worldclim_fick_2017/data",
  path_watch = "~/data/archive/wfdei_weedon_2014/data",
  crop_map = rnaturalearth::ne_countries(scale = "medium", 
                                         country = "Switzerland", 
                                         returnclass = "sf"),
  month = "01",     # February
  cores = 1
)
```

Let's take a look at the downscaled data, comparing to the original WATCH-WFDEI map.
```{r}
source("R/plot_daily.R")

# Plot original daily average temperature
plot_daily("data/tavg_vpd_daily_197901.tif",
           layer_name = "tavg", day = 0)

# Plot downscaled temperature
plot_daily("data/tavg_vpd_daily_downscaled_197901.tif",
           layer_name = "tavg", day = 0)
```
